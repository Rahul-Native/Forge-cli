name: Remove Old Files

on:
  push:
    branches:
      - main

jobs:
  remove_old_files:
    name: Remove old files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Install Git
      run: sudo apt-get install git -y
      
    - name: Set up Git credentials
      run: |
        git config --global user.email "${{ github.event.pusher.email }}"
        git config --global user.name "${{ github.event.pusher.name }}"
      
    - name: Get modified files
      id: get_files
      run: |
            git diff --name-only ${{ github.sha }}^ ${{ github.sha }} > modified_files.txt
      
    - name: Extract folders
      run: |
        awk -F'/' '{print $1"/"$2}' modified_files.txt | sort -u > modified_folders.txt
      
    - name: Debug modified folders
      run: cat modified_folders.txt
      
    - name: Remove old files in modified folders
      run: |
        while IFS= read -r folder; do
          echo "Removing old files in folder: $folder"
          find "$folder" -type f -print0 | xargs -0 ls -1t | tail -n +4 | xargs -d '\n' rm -f
        done < modified_folders.txt
        
    - name: Commit changes
      run: |
        git add .
        git diff --quiet && git diff --staged --quiet || git commit -m "Remove old files 1"
        
    - name: Push changes
      if: success()
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.RV_TOKEN }}
